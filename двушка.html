<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ö–æ—Ñ–µ-–¥—Ä–æ–º: –û–±–≥–æ–Ω / –ü–∞—Ä–∫–æ–≤–∫–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: #111;
      font-family: system-ui, sans-serif;
      color: #fff;
      overflow: hidden;
      touch-action: none;
    }
    #game {
      width: 100vw;
      height: 100vh;
      position: relative;
      overflow: hidden;
      background: radial-gradient(circle at top, #333 0, #111 60%);
    }

    /* –î–æ—Ä–æ–≥–∞ / –ø–æ–ª–µ –∏–≥—Ä—ã */
    #road {
      position: absolute;
      width: 70vw;
      max-width: 420px;
      height: 100%;
      background: #222;
      left: 50%;
      transform: translateX(-50%);
      border-left: 6px solid #777;
      border-right: 6px solid #777;
      overflow: hidden;
    }

    /* –†–∞–∑–º–µ—Ç–∫–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ –û–±–≥–æ–Ω */
    .lane-line {
      position: absolute;
      width: 4px;
      height: 40px;
      background: #ddd;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0.7;
    }

    /* –ú–∞—à–∏–Ω–∞ –∏–≥—Ä–æ–∫–∞ –≤ —Ä–µ–∂–∏–º–µ –û–±–≥–æ–Ω */
    #raceCar {
      position: absolute;
      width: 40px;
      height: 70px;
      background: #00c853;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.6);
      display: none;
    }

    /* –ú–∞—à–∏–Ω–∞ –∏–≥—Ä–æ–∫–∞ –≤ —Ä–µ–∂–∏–º–µ –ü–∞—Ä–∫–æ–≤–∫–∞ */
    #parkingCar {
      position: absolute;
      width: 50px;
      height: 90px;
      background: #00b0ff;
      border-radius: 10px;
      box-shadow: 0 0 12px rgba(0,0,0,0.7);
      transform-origin: 50% 50%;
      display: none;
    }

    /* –í—Ä–∞–∂–µ—Å–∫–∏–µ –º–∞—à–∏–Ω—ã –≤ —Ä–µ–∂–∏–º–µ –û–±–≥–æ–Ω */
    .enemy {
      position: absolute;
      width: 40px;
      height: 70px;
      background: #e53935;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.6);
    }

    /* –ó–æ–Ω–∞ –ø–∞—Ä–∫–æ–≤–∫–∏ */
    #parkingBox {
      position: absolute;
      width: 60%;
      height: 30%;
      border: 3px dashed #fff;
      border-radius: 10px;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0.9;
      display: none;
    }
    #parkingBox::after {
      content: "–ë–æ–∫—Å";
      position: absolute;
      top: 4px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 14px;
      color: #fff;
      opacity: 0.8;
    }

    /* HUD */
    #hud {
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 16px;
      font-size: 16px;
      z-index: 5;
      text-shadow: 0 0 4px #000;
    }

    /* –û–±—â–∏–µ –æ–≤–µ—Ä–ª–µ–∏ */
    .overlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.75);
      z-index: 10;
      text-align: center;
      padding: 20px;
    }

    /* –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω */
    #introScreen {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    #introScreen h1 {
      font-size: 26px;
      margin-bottom: 4px;
    }
    .intro-text {
      font-size: 18px;
      max-width: 280px;
      margin: 0 auto;
      opacity: 0;
      animation: fadeUp 2.2s ease-out forwards;
    }
    @keyframes fadeUp {
      0% { opacity: 0; transform: translateY(16px); }
      60% { opacity: 1; transform: translateY(0); }
      100% { opacity: 1; transform: translateY(0); }
    }

    /* –ú–µ–Ω—é —Ä–µ–∂–∏–º–æ–≤ */
    #modeMenu h2 {
      margin-bottom: 12px;
    }
    .mode-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }
    .mode-btn {
      border: none;
      padding: 10px 20px;
      border-radius: 999px;
      font-size: 16px;
      background: #ffb300;
      color: #000;
      font-weight: 600;
    }

    button {
      border: none;
      padding: 10px 20px;
      border-radius: 999px;
      font-size: 16px;
      margin-top: 10px;
      background: #ffb300;
      color: #000;
      font-weight: 600;
    }
    button:active {
      transform: scale(0.96);
    }

    /* –≠–∫—Ä–∞–Ω Game Over */
    #gameOver {
      flex-direction: column;
      gap: 8px;
    }

    /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –û–±–≥–æ–Ω */
    #raceControls {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      z-index: 6;
    }
    .ctrl-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.12);
      color: #fff;
      font-size: 28px;
    }

    /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ü–∞—Ä–∫–æ–≤–∫–∞ */
    #parkingControls {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      flex-direction: column;
      gap: 6px;
      z-index: 6;
      align-items: center;
    }
    #parkingControls-row {
      display: flex;
      gap: 14px;
    }
    .p-btn {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      background: rgba(255,255,255,0.12);
      color: #fff;
      font-size: 24px;
      border: none;
    }
    .p-btn-small {
      width: 90px;
      height: 40px;
      border-radius: 999px;
      font-size: 16px;
    }
  </style>
</head>
<body>
<div id="game">
  <div id="road">
    <div id="parkingBox"></div>
    <div id="raceCar"></div>
    <div id="parkingCar"></div>
  </div>

  <div id="hud">
    <div id="modeLabel">–†–µ–∂–∏–º: ‚Äî</div>
    <div id="info1"></div>
    <div id="info2"></div>
  </div>

  <!-- –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π —Ç–µ–∫—Å—Ç–∞ -->
  <div id="introScreen" class="overlay" style="display:flex;">
    <div>
      <h1>–ö–æ—Ñ–µ-–¥—Ä–æ–º ‚òïüèÅ</h1>
      <p class="intro-text">
        –û–±—ä–µ–∑–∂–∞–π –º–∞—à–∏–Ω—ã, –ø–æ–∫–∞ –∂–¥—ë—à—å —Å–≤–æ–π –∫–æ—Ñ–µ.
      </p>
      <button id="introBtn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    </div>
  </div>

  <!-- –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ -->
  <div id="modeMenu" class="overlay">
    <div>
      <h2>–í—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º</h2>
      <p>–ì–æ–Ω–∫–∞ –∏–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø–∞—Ä–∫–æ–≤–∫–∏ –∑–∞–¥–Ω–∏–º —Ö–æ–¥–æ–º.</p>
      <div class="mode-buttons">
        <button class="mode-btn" id="modeRace">üèé –û–±–≥–æ–Ω</button>
        <button class="mode-btn" id="modeParking">üÖø –ü–∞—Ä–∫–æ–≤–∫–∞ –∑–∞–¥–Ω–∏–º —Ö–æ–¥–æ–º</button>
      </div>
    </div>
  </div>

  <!-- –≠–∫—Ä–∞–Ω Game Over -->
  <div id="gameOver" class="overlay">
    <h2>–§–∏–Ω–∏—à!</h2>
    <p id="resultText"></p>
    <p id="comment"></p>

    <div style="display:flex;flex-direction:column;gap:8px;margin-top:10px;">
      <button id="coffeeNotReadyBtn" style="background:#ffb300;">–ö–æ—Ñ–µ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤</button>
      <button id="coffeeReadyBtn" style="background:#00e676;">–ö–æ—Ñ–µ –≥–æ—Ç–æ–≤</button>
      <button id="backToMenuBtn" style="background:#ccc;">–í –º–µ–Ω—é —Ä–µ–∂–∏–º–æ–≤</button>
    </div>

    <p id="coffeeMsg" style="margin-top:10px;font-size:16px;font-weight:500;"></p>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º –û–±–≥–æ–Ω -->
  <div id="raceControls">
    <button class="ctrl-btn" id="leftBtn">‚óÄ</button>
    <button class="ctrl-btn" id="rightBtn">‚ñ∂</button>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º –ü–∞—Ä–∫–æ–≤–∫–∞ -->
  <div id="parkingControls">
    <button class="p-btn-small" id="forwardBtn">–í–ø–µ—Ä—ë–¥</button>
    <div id="parkingControls-row">
      <button class="p-btn" id="leftTurnBtn">‚ü≤</button>
      <button class="p-btn" id="backwardBtn">–ù–∞–∑–∞–¥</button>
      <button class="p-btn" id="rightTurnBtn">‚ü≥</button>
    </div>
  </div>
</div>

<script>
  const game = document.getElementById('game');
  const road = document.getElementById('road');
  const raceCar = document.getElementById('raceCar');
  const parkingCar = document.getElementById('parkingCar');
  const parkingBox = document.getElementById('parkingBox');

  const modeLabel = document.getElementById('modeLabel');
  const info1 = document.getElementById('info1');
  const info2 = document.getElementById('info2');

  const introScreen = document.getElementById('introScreen');
  const introBtn = document.getElementById('introBtn');
  const modeMenu = document.getElementById('modeMenu');
  const modeRaceBtn = document.getElementById('modeRace');
  const modeParkingBtn = document.getElementById('modeParking');

  const gameOver = document.getElementById('gameOver');
  const resultText = document.getElementById('resultText');
  const commentEl = document.getElementById('comment');
  const coffeeMsg = document.getElementById('coffeeMsg');
  const coffeeNotReadyBtn = document.getElementById('coffeeNotReadyBtn');
  const coffeeReadyBtn = document.getElementById('coffeeReadyBtn');
  const backToMenuBtn = document.getElementById('backToMenuBtn');

  const raceControls = document.getElementById('raceControls');
  const leftBtn = document.getElementById('leftBtn');
  const rightBtn = document.getElementById('rightBtn');

  const parkingControls = document.getElementById('parkingControls');
  const forwardBtn = document.getElementById('forwardBtn');
  const backwardBtn = document.getElementById('backwardBtn');
  const leftTurnBtn = document.getElementById('leftTurnBtn');
  const rightTurnBtn = document.getElementById('rightTurnBtn');

  // –û–±—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  let currentMode = null; // 'race' –∏–ª–∏ 'parking'
  let running = false;
  let lastTime = 0;

  // ==== –†–ï–ñ–ò–ú –û–ë–ì–û–ù ====
  let laneLines = [];
  let enemies = [];
  let score = 0;
  let speed = 3;
  let maxSpeed = 9;
  let lastSpawn = 0;
  let spawnInterval = 900;
  let moveDirection = 0;
  const moveStep = 6;

  function createLaneLines() {
    const roadRect = road.getBoundingClientRect();
    const count = Math.ceil(roadRect.height / 80) + 2;
    laneLines.forEach(l => l.remove());
    laneLines = [];
    for (let i = 0; i < count; i++) {
      const line = document.createElement('div');
      line.className = 'lane-line';
      line.style.top = i * 80 + 'px';
      road.appendChild(line);
      laneLines.push(line);
    }
  }

  function resetRaceCar() {
    const rect = road.getBoundingClientRect();
    const carWidth = raceCar.offsetWidth;
    raceCar.style.bottom = '20px';
    raceCar.style.left = (rect.width / 2 - carWidth / 2) + 'px';
  }

  function spawnEnemy() {
    const enemy = document.createElement('div');
    enemy.className = 'enemy';
    const rect = road.getBoundingClientRect();

    const lanes = [rect.width * 0.2, rect.width * 0.5, rect.width * 0.8];
    const lane = lanes[Math.floor(Math.random() * lanes.length)];
    enemy.style.left = (lane - enemy.offsetWidth / 2) + 'px';
    enemy.style.top = '-90px';

    road.appendChild(enemy);
    enemies.push({ el: enemy, y: -90 });
  }

  function isColliding(a, b) {
    return !(
      a.right < b.left ||
      a.left > b.right ||
      a.bottom < b.top ||
      a.top > b.bottom
    );
  }

  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–ª—å—Ü–µ–º –ø–æ –¥–æ—Ä–æ–≥–µ –≤ —Ä–µ–∂–∏–º–µ –û–±–≥–æ–Ω
  road.addEventListener('pointermove', e => {
    if (!running || currentMode !== 'race') return;
    const rect = road.getBoundingClientRect();
    let x = e.clientX - rect.left - raceCar.offsetWidth / 2;
    x = Math.max(0, Math.min(x, rect.width - raceCar.offsetWidth));
    raceCar.style.left = x + 'px';
  });

  // –ö–Ω–æ–ø–∫–∏ –≤–ª–µ–≤–æ / –≤–ø—Ä–∞–≤–æ
  leftBtn.addEventListener('pointerdown', () => { if (currentMode === 'race') moveDirection = -1; });
  rightBtn.addEventListener('pointerdown', () => { if (currentMode === 'race') moveDirection = 1; });
  ['pointerup','pointerleave','pointercancel'].forEach(ev => {
    leftBtn.addEventListener(ev, () => { if (currentMode === 'race') moveDirection = 0; });
    rightBtn.addEventListener(ev, () => { if (currentMode === 'race') moveDirection = 0; });
  });

  function moveRaceCarButtons() {
    if (!running || currentMode !== 'race') return;
    const rect = road.getBoundingClientRect();
    let x = raceCar.offsetLeft + moveDirection * moveStep;
    x = Math.max(0, Math.min(x, rect.width - raceCar.offsetWidth));
    raceCar.style.left = x + 'px';
  }

  function updateRace(timestamp, delta) {
    // –†–∞–∑–º–µ—Ç–∫–∞
    laneLines.forEach(line => {
      let top = parseFloat(line.style.top);
      top += speed * 2;
      const roadRect = road.getBoundingClientRect();
      if (top > roadRect.height) top = -40;
      line.style.top = top + 'px';
    });

    moveRaceCarButtons();

    const roadRect = road.getBoundingClientRect();
    const playerRect = raceCar.getBoundingClientRect();

    for (let i = enemies.length - 1; i >= 0; i--) {
      const obj = enemies[i];
      obj.y += speed * 2.2;
      obj.el.style.top = obj.y + 'px';

      const enemyRect = obj.el.getBoundingClientRect();
      if (isColliding(playerRect, enemyRect)) {
        endGame('crash');
        return;
      }

      if (obj.y > roadRect.height + 100) {
        obj.el.remove();
        enemies.splice(i, 1);
        score++;
        info1.textContent = '–û–±–æ–≥–Ω–∞–ª: ' + score;

        if (score > 0 && score % 10 === 0 && speed < maxSpeed) {
          speed += 0.01;
          info2.textContent = '–°–∫–æ—Ä–æ—Å—Ç—å: ' + speed.toFixed(1) + 'x';
          spawnInterval = Math.max(450, spawnInterval - 0.1);
        }
      }
    }

    if (timestamp - lastSpawn > spawnInterval) {
      spawnEnemy();
      lastSpawn = timestamp;
    }
  }

  function startRaceMode() {
    currentMode = 'race';
    running = false;

    // UI
    modeLabel.textContent = '–†–µ–∂–∏–º: –û–±–≥–æ–Ω';
    info1.textContent = '–û–±–æ–≥–Ω–∞–ª: 0';
    info2.textContent = '–°–∫–æ—Ä–æ—Å—Ç—å: 1x';
    raceControls.style.display = 'flex';
    parkingControls.style.display = 'none';
    parkingBox.style.display = 'none';
    parkingCar.style.display = 'none';
    raceCar.style.display = 'block';

    // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
    laneLines.forEach(l => l.remove());
    laneLines = [];
    enemies.forEach(e => e.el.remove());
    enemies = [];
    score = 0;
    speed = 3;
    spawnInterval = 900;
    moveDirection = 0;
    createLaneLines();
    resetRaceCar();

    lastTime = performance.now();
    lastSpawn = lastTime;
    gameOver.style.display = 'none';
    modeMenu.style.display = 'none';

    running = true;
    requestAnimationFrame(gameLoop);
  }

  // ==== –†–ï–ñ–ò–ú –ü–ê–†–ö–û–í–ö–ê ====
  let carX = 0;
  let carY = 0;
  let carAngle = 0; // –≤ —Ä–∞–¥–∏–∞–Ω–∞—Ö
  let forwardPressed = false;
  let backwardPressed = false;
  let turnLeftPressed = false;
  let turnRightPressed = false;

  function resetParkingCar() {
    const rect = road.getBoundingClientRect();
    const carRect = { w: parkingCar.offsetWidth, h: parkingCar.offsetHeight };

    carX = rect.width / 2;
    carY = rect.height * 0.8;
    carAngle = -Math.PI / 2; // "—Å–º–æ—Ç—Ä–∏—Ç" –≤–≤–µ—Ä—Ö

    updateParkingCarTransform();
  }

  function updateParkingCarTransform() {
    // –ø–æ–∑–∏—Ü–∏—é –∑–∞–¥–∞—ë–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ road
    parkingCar.style.left = (carX - parkingCar.offsetWidth / 2) + 'px';
    parkingCar.style.top = (carY - parkingCar.offsetHeight / 2) + 'px';
    parkingCar.style.transform = `translateZ(0) rotate(${carAngle}rad)`;
  }

  function startParkingMode() {
    currentMode = 'parking';
    running = false;

    modeLabel.textContent = '–†–µ–∂–∏–º: –ü–∞—Ä–∫–æ–≤–∫–∞ –∑–∞–¥–Ω–∏–º —Ö–æ–¥–æ–º';
    info1.textContent = '–ó–∞–¥–∞—á–∞: –∑–∞–≥–Ω–∞—Ç—å –º–∞—à–∏–Ω—É –≤ –±–æ–∫—Å.';
    info2.textContent = '–ò—Å–ø–æ–ª—å–∑—É–π –í–ø–µ—Ä—ë–¥ / –ù–∞–∑–∞–¥ –∏ –ø–æ–≤–æ—Ä–æ—Ç—ã.';

    raceControls.style.display = 'none';
    parkingControls.style.display = 'flex';
    parkingBox.style.display = 'block';
    raceCar.style.display = 'none';
    parkingCar.style.display = 'block';

    laneLines.forEach(l => l.remove());
    laneLines = [];
    enemies.forEach(e => e.el.remove());
    enemies = [];

    forwardPressed = backwardPressed = false;
    turnLeftPressed = turnRightPressed = false;

    const rect = road.getBoundingClientRect();
    parkingBox.style.display = 'block';

    resetParkingCar();

    lastTime = performance.now();
    gameOver.style.display = 'none';
    modeMenu.style.display = 'none';

    running = true;
    requestAnimationFrame(gameLoop);
  }

  // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä–∫–æ–≤–∫–æ–π
  function addPressToggle(btn, flagName) {
    btn.addEventListener('pointerdown', () => {
      if (currentMode !== 'parking') return;
      window[flagName] = true;
    });
    ['pointerup','pointerleave','pointercancel'].forEach(ev => {
      btn.addEventListener(ev, () => {
        if (currentMode !== 'parking') return;
        window[flagName] = false;
      });
    });
  }
  addPressToggle(forwardBtn, 'forwardPressed');
  addPressToggle(backwardBtn, 'backwardPressed');
  addPressToggle(leftTurnBtn, 'turnLeftPressed');
  addPressToggle(rightTurnBtn, 'turnRightPressed');

  function updateParking(delta) {
    const rect = road.getBoundingClientRect();
    const speedBase = 0.12 * delta;  // —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∑–∞ –∫–∞–¥—Ä
    let v = 0;

    if (forwardPressed) v += speedBase;
    if (backwardPressed) v -= speedBase;

    const turnSpeed = 0.004 * delta;
    if (v !== 0) {
      if (turnLeftPressed) carAngle -= turnSpeed * Math.sign(v);
      if (turnRightPressed) carAngle += turnSpeed * Math.sign(v);
    }

    carX += Math.cos(carAngle) * v;
    carY += Math.sin(carAngle) * v;

    // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –∫—Ä–∞—è–º –¥–æ—Ä–æ–≥–∏
    const margin = 10;
    const halfW = parkingCar.offsetWidth / 2;
    const halfH = parkingCar.offsetHeight / 2;
    carX = Math.max(halfW + margin, Math.min(rect.width - halfW - margin, carX));
    carY = Math.max(halfH + margin, Math.min(rect.height - halfH - margin, carY));

    updateParkingCarTransform();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤ –±–æ–∫—Å–µ –ª–∏ –º–∞—à–∏–Ω–∞ (–ø–æ —Ü–µ–Ω—Ç—Ä—É –º–∞—à–∏–Ω—ã)
    const boxRect = parkingBox.getBoundingClientRect();
    const carCenterX = parkingCar.getBoundingClientRect().left + parkingCar.offsetWidth / 2;
    const carCenterY = parkingCar.getBoundingClientRect().top + parkingCar.offsetHeight / 2;

    if (
      carCenterX > boxRect.left + 8 &&
      carCenterX < boxRect.right - 8 &&
      carCenterY > boxRect.top + 8 &&
      carCenterY < boxRect.bottom - 8 &&
      Math.abs(carAngle + Math.PI/2) < 0.6 // –ø—Ä–∏–º–µ—Ä–Ω–æ –∑–∞–¥–æ–º –≤ –±–æ–∫—Å (–æ—Ä–∏–µ–Ω—Ç–∏—Ä –≤–≤–µ—Ä—Ö)
    ) {
      // –£—Å–ø–µ—à–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞
      endGame('parking-success');
    }
  }

  // ==== –û–±—â–∏–π –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª ====
  function gameLoop(timestamp) {
    if (!running) return;
    const delta = timestamp - lastTime;
    lastTime = timestamp;

    if (currentMode === 'race') {
      updateRace(timestamp, delta);
    } else if (currentMode === 'parking') {
      updateParking(delta);
    }

    requestAnimationFrame(gameLoop);
  }

  // ==== –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≥—Ä—ã ====
  function endGame(reason) {
    running = false;
    gameOver.style.display = 'flex';
    coffeeMsg.textContent = '';

    if (currentMode === 'race') {
      resultText.textContent = '–¢—ã –æ–±–æ–≥–Ω–∞–ª –º–∞—à–∏–Ω: ' + score;
      if (reason === 'crash') {
        commentEl.textContent = '–ù–µ–º–Ω–æ–≥–æ –∑–∞–¥–µ–ª —Å–æ–ø–µ—Ä–Ω–∏–∫–∞, –±—ã–≤–∞–µ—Ç!';
      } else {
        commentEl.textContent = '';
      }
    } else if (currentMode === 'parking') {
      if (reason === 'parking-success') {
        resultText.textContent = '–ü–∞—Ä–∫–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ú–∞—à–∏–Ω–∞ –≤ –±–æ–∫—Å–µ.';
        commentEl.textContent = '–û—Ç–ª–∏—á–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ –∑–∞–¥–Ω–µ–≥–æ —Ö–æ–¥–∞!';
      } else {
        resultText.textContent = '–ü–∞—Ä–∫–æ–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å.';
        commentEl.textContent = '–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ ‚Äî –ø—Ä–∞–∫—Ç–∏–∫–∞ —Ä–µ—à–∞–µ—Ç.';
      }
    }
  }

  // ==== –ö–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –ø—Ä–æ–∏–≥—Ä—ã—à–∞ ====
  coffeeNotReadyBtn.onclick = () => {
    coffeeMsg.textContent = '–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑, –µ—Å–ª–∏ –∫–æ—Ñ–µ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤ ‚òï';
    setTimeout(() => {
      gameOver.style.display = 'none';
      if (currentMode === 'race') startRaceMode();
      else if (currentMode === 'parking') startParkingMode();
    }, 1200);
  };

  coffeeReadyBtn.onclick = () => {
    coffeeMsg.textContent = '–ù–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å –Ω–∞–ø–∏—Ç–∫–æ–º ‚òï';
  };

  backToMenuBtn.onclick = () => {
    gameOver.style.display = 'none';
    modeMenu.style.display = 'flex';
  };

  // ==== –ù–∞–≤–∏–≥–∞—Ü–∏—è: –∏–Ω—Ç—Ä–æ -> –º–µ–Ω—é -> —Ä–µ–∂–∏–º ====
  introBtn.onclick = () => {
    introScreen.style.display = 'none';
    modeMenu.style.display = 'flex';
  };

  modeRaceBtn.onclick = () => {
    startRaceMode();
  };
  modeParkingBtn.onclick = () => {
    startParkingMode();
  };

  // –∞–Ω—Ç–∏-–∂–µ—Å—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
  document.addEventListener('gesturestart', e => e.preventDefault());
</script>
</body>
</html>
