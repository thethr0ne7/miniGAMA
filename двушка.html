<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ö–æ—Ñ–µ-–¥—Ä–æ–º: –û–±–≥–æ–Ω</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }
    body {
      background: #111;
      font-family: system-ui, sans-serif;
      color: #fff;
      touch-action: none;
    }
    #game {
      width: 100vw;
      height: 100vh;
      position: relative;
      overflow: hidden;
      background: radial-gradient(circle at top, #333 0, #111 60%);
      transition: background 0.2s ease, transform 0.2s ease;
    }

    /* –î–æ—Ä–æ–≥–∞ */
    #road {
      position: absolute;
      width: 70vw;
      max-width: 420px;
      height: 100%;
      background: #222;
      left: 50%;
      transform: translateX(-50%);
      border-left: 6px solid #777;
      border-right: 6px solid #777;
      overflow: hidden;
      transition: filter 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    /* –†–∞–∑–º–µ—Ç–∫–∞ */
    .lane-line {
      position: absolute;
      width: 4px;
      height: 40px;
      background: #ddd;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0.7;
    }

    /* –ú–∞—à–∏–Ω–∞ –∏–≥—Ä–æ–∫–∞ (–µ—â—ë –≤—ã—à–µ) */
    #raceCar {
      position: absolute;
      width: 40px;
      height: 70px;
      background: #00c853;
      bottom: 150px; /* –±—ã–ª–æ 110px */
      left: 50%;
      transform: translateX(-50%);
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.6);
      display: none;
    }

    /* –í—Ä–∞–∂–µ—Å–∫–∏–µ –º–∞—à–∏–Ω—ã */
    .enemy {
      position: absolute;
      width: 40px;
      height: 70px;
      background: #e53935;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.6);
    }

    /* –ö–æ—Ñ–µ–π–Ω—ã–π –±–æ–Ω—É—Å */
    .bonus {
      position: absolute;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: radial-gradient(circle at top, #ffe0b2 0, #ff9800 70%, #e65100 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 0 10px rgba(255,152,0,0.8);
    }

    /* HUD */
    #hud {
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 16px;
      font-size: 14px;
      z-index: 5;
      text-shadow: 0 0 4px #000;
      align-items: center;
    }
    #hud span.value {
      font-weight: 700;
    }

    /* –ö–Ω–æ–ø–∫–∞ Nitro ‚Äî —Ç–µ–ø–µ—Ä—å —Å–Ω–∏–∑—É —Å–ª–µ–≤–∞ */
    .nitro-btn {
      position: absolute;
      bottom: 100px;
      left: 10px;
      z-index: 7;
      padding: 6px 14px;
      font-size: 14px;
      border-radius: 999px;
      background: #ff6d00;
      color: #000;
      font-weight: 700;
      border: none;
      box-shadow: 0 0 10px rgba(255,109,0,0.7);
    }
    .nitro-btn:active {
      transform: scale(0.96);
    }
    .nitro-btn.cooldown {
      background: #555;
      color: #ccc;
      opacity: 0.6;
      box-shadow: none;
    }
    .nitro-btn.active {
      background: #ffffff;
      color: #000;
      box-shadow: 0 0 14px rgba(255,255,255,0.9);
    }

    /* –û–≤–µ—Ä–ª–µ–∏ */
    .overlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.75);
      z-index: 10;
      text-align: center;
      padding: 20px;
    }

    /* –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π —Ç–µ–∫—Å—Ç–∞ */
    #introScreen {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    #introScreen h1 {
      font-size: 26px;
      margin-bottom: 4px;
    }
    .intro-text {
      font-size: 18px;
      max-width: 280px;
      margin: 0 auto;
      opacity: 0;
      animation: fadeUp 2.2s ease-out forwards;
    }
    @keyframes fadeUp {
      0%   { opacity: 0; transform: translateY(16px); }
      60%  { opacity: 1; transform: translateY(0); }
      100% { opacity: 1; transform: translateY(0); }
    }

    button {
      border: none;
      padding: 10px 20px;
      border-radius: 999px;
      font-size: 16px;
      margin-top: 10px;
      background: #ffb300;
      color: #000;
      font-weight: 600;
    }
    button:active {
      transform: scale(0.96);
    }

    /* –≠–∫—Ä–∞–Ω Game Over */
    #gameOver {
      flex-direction: column;
      gap: 8px;
    }

    /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
    #raceControls {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      z-index: 6;
    }
    .ctrl-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.12);
      color: #fff;
      font-size: 28px;
    }

    /* –í–∏–∑—É–∞–ª Nitro –∏ Slow-motion */
    .nitro-mode #road {
      background: #111;
      box-shadow: 0 0 40px rgba(255,120,0,0.9);
    }
    .slow-motion #road {
      filter: brightness(0.7);
    }

    /* –¢—Ä—è—Å–∫–∞ —ç–∫—Ä–∞–Ω–∞ –ø—Ä–∏ –∞–≤–∞—Ä–∏–∏ */
    .hit-shake {
      animation: hitShake 0.25s;
    }
    @keyframes hitShake {
      0%   { transform: translateX(0); }
      20%  { transform: translateX(-6px); }
      40%  { transform: translateX(6px); }
      60%  { transform: translateX(-4px); }
      80%  { transform: translateX(4px); }
      100% { transform: translateX(0); }
    }
  </style>
</head>
<body>
<div id="game">
  <div id="road">
    <div id="raceCar"></div>
  </div>

  <div id="hud">
    <div>–û–±–æ–≥–Ω–∞–ª: <span id="score" class="value">0</span></div>
    <div>–°–∫–æ—Ä–æ—Å—Ç—å: <span id="speed" class="value">1</span>x</div>
    <div>–†–µ–∫–æ—Ä–¥: <span id="bestScore" class="value">0</span></div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ Nitro -->
  <button id="nitroBtn" class="nitro-btn">Nitro</button>

  <!-- –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π –Ω–∞–¥–ø–∏—Å–∏ -->
  <div id="introScreen" class="overlay" style="display:flex;">
    <div>
      <h1>–ö–æ—Ñ–µ-–¥—Ä–æ–º ‚òïüèÅ</h1>
      <p class="intro-text">
        –û–±—ä–µ–∑–∂–∞–π –º–∞—à–∏–Ω—ã, –ø–æ–∫–∞ –∂–¥—ë—à—å —Å–≤–æ–π –∫–æ—Ñ–µ.
      </p>
      <button id="introBtn">–ü–æ–µ—Ö–∞–ª–∏</button>
    </div>
  </div>

  <!-- –≠–∫—Ä–∞–Ω Game Over -->
  <div id="gameOver" class="overlay">
    <h2>–§–∏–Ω–∏—à!</h2>
    <p>–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –∑–∞–µ–∑–¥: <span id="finalScore">0</span> –º–∞—à–∏–Ω</p>
    <p>–¢–≤–æ–π —Ä–µ–∫–æ—Ä–¥: <span id="bestScoreEnd">0</span> –º–∞—à–∏–Ω</p>
    <p id="comment"></p>

    <div style="display:flex;flex-direction:column;gap:8px;margin-top:10px;">
      <button id="coffeeNotReadyBtn" style="background:#ffb300;">–ö–æ—Ñ–µ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤</button>
      <button id="coffeeReadyBtn" style="background:#00e676;">–ö–æ—Ñ–µ –≥–æ—Ç–æ–≤</button>
      <button id="restartBtn" style="background:#ccc;">–ù–æ–≤—ã–π –∑–∞–µ–∑–¥</button>
    </div>

    <p id="coffeeMsg" style="margin-top:10px;font-size:16px;font-weight:500;"></p>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
  <div id="raceControls">
    <button class="ctrl-btn" id="leftBtn">‚óÄ</button>
    <button class="ctrl-btn" id="rightBtn">‚ñ∂</button>
  </div>
</div>

<script>
  const road = document.getElementById('road');
  const raceCar = document.getElementById('raceCar');
  const scoreEl = document.getElementById('score');
  const speedEl = document.getElementById('speed');
  const bestScoreEl = document.getElementById('bestScore');

  const introScreen = document.getElementById('introScreen');
  const introBtn = document.getElementById('introBtn');

  const gameOver = document.getElementById('gameOver');
  const finalScoreEl = document.getElementById('finalScore');
  const bestScoreEndEl = document.getElementById('bestScoreEnd');
  const commentEl = document.getElementById('comment');
  const coffeeMsg = document.getElementById('coffeeMsg');
  const coffeeNotReadyBtn = document.getElementById('coffeeNotReadyBtn');
  const coffeeReadyBtn = document.getElementById('coffeeReadyBtn');
  const restartBtn = document.getElementById('restartBtn');

  const leftBtn = document.getElementById('leftBtn');
  const rightBtn = document.getElementById('rightBtn');
  const nitroBtn = document.getElementById('nitroBtn');
  const gameEl = document.getElementById('game');

  // –≤–∏–±—Ä–æ
  function vibrate(pattern) {
    if (navigator.vibrate) {
      navigator.vibrate(pattern);
    }
  }

  // —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
  let laneLines = [];
  let enemies = [];
  let bonuses = [];
  let score = 0;
  let speed = 3;
  let maxSpeed = 9;
  let lastSpawn = 0;
  let spawnInterval = 900;
  let moveDirection = 0;
  const moveStep = 6;
  let running = false;
  let lastTime = 0;

  // —Ä–µ–∫–æ—Ä–¥
  let bestScore = parseInt(localStorage.getItem('coffeeRacerBest') || '0', 10);
  if (isNaN(bestScore)) bestScore = 0;
  bestScoreEl.textContent = bestScore;

  // Nitro
  let isNitroActive = false;
  let nitroEndTime = 0;
  let nitroCooldownEndTime = 0;
  const NITRO_DURATION = 2500;   // –º—Å
  const NITRO_COOLDOWN = 6000;  // –º—Å
  const NITRO_MULTIPLIER = 2.2;

  // Slow-motion –æ—Ç –∫–æ—Ñ–µ
  let isSlowMotionActive = false;
  let slowMotionEndTime = 0;
  const SLOW_MOTION_DURATION = 3500; // –º—Å
  const SLOW_MOTION_FACTOR = 0.5;

  function createLaneLines() {
    const roadRect = road.getBoundingClientRect();
    const count = Math.ceil(roadRect.height / 80) + 2;
    laneLines.forEach(l => l.remove());
    laneLines = [];
    for (let i = 0; i < count; i++) {
      const line = document.createElement('div');
      line.className = 'lane-line';
      line.style.top = i * 80 + 'px';
      road.appendChild(line);
      laneLines.push(line);
    }
  }

  function resetRaceCar() {
    const rect = road.getBoundingClientRect();
    const carWidth = raceCar.offsetWidth;
    raceCar.style.left = (rect.width / 2 - carWidth / 2) + 'px';
  }

  function spawnEnemy() {
    const enemy = document.createElement('div');
    enemy.className = 'enemy';
    const rect = road.getBoundingClientRect();
    const lanes = [rect.width * 0.2, rect.width * 0.5, rect.width * 0.8];
    const lane = lanes[Math.floor(Math.random() * lanes.length)];
    enemy.style.left = (lane - enemy.offsetWidth / 2) + 'px';
    enemy.style.top = '-90px';
    road.appendChild(enemy);
    enemies.push({ el: enemy, y: -90 });

    // —à–∞–Ω—Å –∑–∞—Å–ø–∞–≤–Ω–∏—Ç—å –∫–æ—Ñ–µ–π–Ω—ã–π –±–æ–Ω—É—Å
    if (Math.random() < 0.15) {
      spawnBonus();
    }
  }

  function spawnBonus() {
    const bonus = document.createElement('div');
    bonus.className = 'bonus';
    bonus.textContent = '‚òï';
    const rect = road.getBoundingClientRect();
    bonus.style.left = (Math.random() * (rect.width - 40) + 20) + 'px';
    bonus.style.top = '-60px';
    road.appendChild(bonus);
    bonuses.push({ el: bonus, y: -60 });
  }

  function isColliding(a, b) {
    return !(
      a.right < b.left ||
      a.left > b.right ||
      a.bottom < b.top ||
      a.top > b.bottom
    );
  }

  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–ª—å—Ü–µ–º (–ø–æ –¥–æ—Ä–æ–≥–µ)
  road.addEventListener('pointermove', e => {
    if (!running) return;
    const rect = road.getBoundingClientRect();
    let x = e.clientX - rect.left - raceCar.offsetWidth / 2;
    x = Math.max(0, Math.min(x, rect.width - raceCar.offsetWidth));
    raceCar.style.left = x + 'px';
  });

  // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  leftBtn.addEventListener('pointerdown', () => { moveDirection = -1; });
  rightBtn.addEventListener('pointerdown', () => { moveDirection = 1; });
  ['pointerup','pointerleave','pointercancel'].forEach(ev => {
    leftBtn.addEventListener(ev, () => moveDirection = 0);
    rightBtn.addEventListener(ev, () => moveDirection = 0);
  });

  function moveRaceCarButtons() {
    if (!running) return;
    const rect = road.getBoundingClientRect();
    let x = raceCar.offsetLeft + moveDirection * moveStep;
    x = Math.max(0, Math.min(x, rect.width - raceCar.offsetWidth));
    raceCar.style.left = x + 'px';
  }

  function triggerSlowMotion(timestamp) {
    isSlowMotionActive = true;
    slowMotionEndTime = timestamp + SLOW_MOTION_DURATION;
    gameEl.classList.add('slow-motion');
  }

  function updateNitroButtonState(now) {
    if (isNitroActive) {
      nitroBtn.classList.add('active');
      nitroBtn.classList.remove('cooldown');
      nitroBtn.disabled = true;
    } else if (now < nitroCooldownEndTime) {
      nitroBtn.classList.remove('active');
      nitroBtn.classList.add('cooldown');
      nitroBtn.disabled = true;
    } else {
      nitroBtn.classList.remove('active');
      nitroBtn.classList.remove('cooldown');
      nitroBtn.disabled = false;
    }
  }

  nitroBtn.addEventListener('click', () => {
    if (!running) return;
    const now = performance.now();
    if (isNitroActive) return;
    if (now < nitroCooldownEndTime) return;

    isNitroActive = true;
    nitroEndTime = now + NITRO_DURATION;
    gameEl.classList.add('nitro-mode');
    updateNitroButtonState(now);
  });

  function updateGame(timestamp, delta) {
    // –º–Ω–æ–∂–∏—Ç–µ–ª—å —Å–∫–æ—Ä–æ—Å—Ç–∏
    let speedFactor = 1;

    // —Å–ª–æ—É-–º–æ –æ—Ç –∫–æ—Ñ–µ
    if (isSlowMotionActive) {
      if (timestamp >= slowMotionEndTime) {
        isSlowMotionActive = false;
        gameEl.classList.remove('slow-motion');
      } else {
        speedFactor = SLOW_MOTION_FACTOR;
      }
    }

    // Nitro
    if (isNitroActive) {
      if (timestamp >= nitroEndTime) {
        isNitroActive = false;
        nitroCooldownEndTime = timestamp + NITRO_COOLDOWN;
        gameEl.classList.remove('nitro-mode');
      } else {
        speedFactor = NITRO_MULTIPLIER;
      }
    }
    updateNitroButtonState(timestamp);

    const effectiveSpeed = speed * speedFactor;
    speedEl.textContent = (speed * speedFactor).toFixed(1);

    // —Ä–∞–∑–º–µ—Ç–∫–∞
    laneLines.forEach(line => {
      let top = parseFloat(line.style.top);
      top += effectiveSpeed * 2;
      const roadRect = road.getBoundingClientRect();
      if (top > roadRect.height) top = -40;
      line.style.top = top + 'px';
    });

    moveRaceCarButtons();

    const roadRect = road.getBoundingClientRect();
    const playerRect = raceCar.getBoundingClientRect();

    // –≤—Ä–∞–≥–∏
    for (let i = enemies.length - 1; i >= 0; i--) {
      const obj = enemies[i];
      obj.y += effectiveSpeed * 2.2;
      obj.el.style.top = obj.y + 'px';

      const enemyRect = obj.el.getBoundingClientRect();
      if (isColliding(playerRect, enemyRect)) {
        endGame();
        return;
      }

      if (obj.y > roadRect.height + 100) {
        obj.el.remove();
        enemies.splice(i, 1);
        score += 1;
        scoreEl.textContent = score;

        if (score > 0 && score % 10 === 0 && speed < maxSpeed) {
          speed += 0.2;
          spawnInterval = Math.max(450, spawnInterval - 10);
        }
      }
    }

    // –±–æ–Ω—É—Å—ã
    for (let i = bonuses.length - 1; i >= 0; i--) {
      const obj = bonuses[i];
      obj.y += effectiveSpeed * 1.4;
      obj.el.style.top = obj.y + 'px';

      const bonusRect = obj.el.getBoundingClientRect();
      if (isColliding(playerRect, bonusRect)) {
        score += 5;
        scoreEl.textContent = score;
        vibrate(60);
        triggerSlowMotion(timestamp);
        obj.el.remove();
        bonuses.splice(i, 1);
        continue;
      }

      if (obj.y > roadRect.height + 80) {
        obj.el.remove();
        bonuses.splice(i, 1);
      }
    }

    // —Å–ø–∞–≤–Ω –≤—Ä–∞–≥–æ–≤
    if (timestamp - lastSpawn > spawnInterval) {
      spawnEnemy();
      lastSpawn = timestamp;
    }
  }

  function gameLoop(timestamp) {
    if (!running) return;
    const delta = timestamp - lastTime;
    lastTime = timestamp;

    updateGame(timestamp, delta);

    requestAnimationFrame(gameLoop);
  }

  function startGame() {
    enemies.forEach(e => e.el.remove());
    enemies = [];
    bonuses.forEach(b => b.el.remove());
    bonuses = [];
    score = 0;
    speed = 3;
    spawnInterval = 900;
    moveDirection = 0;
    scoreEl.textContent = score;
    speedEl.textContent = '1';

    createLaneLines();
    raceCar.style.display = 'block';
    resetRaceCar();

    gameOver.style.display = 'none';
    coffeeMsg.textContent = '';

    isNitroActive = false;
    nitroEndTime = 0;
    nitroCooldownEndTime = 0;
    isSlowMotionActive = false;
    slowMotionEndTime = 0;
    gameEl.classList.remove('nitro-mode');
    gameEl.classList.remove('slow-motion');
    updateNitroButtonState(performance.now());

    running = true;
    lastTime = performance.now();
    lastSpawn = lastTime;
    requestAnimationFrame(gameLoop);
  }

  function endGame() {
    running = false;

    vibrate([80, 40, 120]);
    gameEl.classList.add('hit-shake');
    setTimeout(() => {
      gameEl.classList.remove('hit-shake');
    }, 250);

    finalScoreEl.textContent = score;

    if (score > bestScore) {
      bestScore = score;
      localStorage.setItem('coffeeRacerBest', String(bestScore));
      bestScoreEl.textContent = bestScore;
    }
    bestScoreEndEl.textContent = bestScore;

    let text = '';
    if (score < 10) text = '–ü–æ—Ö–æ–∂–µ, —Ç—ã —Ç–æ–ª—å–∫–æ –≤—ã–µ—Ö–∞–ª –∏–∑ –±–æ–∫—Å–∞.';
    else if (score < 25) text = '–ù–µ–ø–ª–æ—Ö–æ –≤–æ–¥–∏—à—å! üëå';
    else text = '–¢—ã –Ω–∞—Å—Ç–æ—è—â–∏–π –ø–∏–ª–æ—Ç –∞–≤—Ç–æ–¥—Ä–æ–º–∞! üòé';

    commentEl.textContent = text;
    coffeeMsg.textContent = '';
    gameOver.style.display = 'flex';
  }

  // –ö–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –ø—Ä–æ–∏–≥—Ä—ã—à–∞
  coffeeNotReadyBtn.onclick = () => {
    coffeeMsg.textContent = '–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑, –µ—Å–ª–∏ –∫–æ—Ñ–µ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤ ‚òï';
    setTimeout(() => {
      startGame();
    }, 1200);
  };

  coffeeReadyBtn.onclick = () => {
    coffeeMsg.textContent = '–ù–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å –Ω–∞–ø–∏—Ç–∫–æ–º ‚òï';
  };

  restartBtn.onclick = () => {
    coffeeMsg.textContent = '';
    startGame();
  };

  // –ò–Ω—Ç—Ä–æ -> —Å—Ç–∞—Ä—Ç –∏–≥—Ä—ã
  introBtn.onclick = () => {
    introScreen.style.display = 'none';
    startGame();
  };

  /* ===== –ü–û–õ–ù–ê–Ø –ë–õ–û–ö–ò–†–û–í–ö–ê –°–ö–†–û–õ–õ–ò–ù–ì–ê –ò –ó–£–ú–ê ===== */
  (function preventScrolling() {
    const block = (e) => e.preventDefault();

    window.addEventListener('scroll', block, { passive: false });
    window.addEventListener('wheel', block, { passive: false });
    window.addEventListener('touchmove', block, { passive: false });

    window.addEventListener('touchstart', (e) => {
      if (e.touches.length > 1) e.preventDefault();
    }, { passive: false });

    document.body.addEventListener('touchmove', (e) => {
      e.preventDefault();
    }, { passive: false });

    document.addEventListener('gesturestart', (e) => e.preventDefault(), { passive: false });
  })();
</script>
</body>
</html>
